# Цель

Документ описывает обязательные меры безопасности для Emotion Diary и связывает их с категориями OWASP ASVS 5.0. Требования распространяются на реализацию, инфраструктуру и процессы сопровождения, обеспечивая постоянный контроль за безопасностью вебхука Telegram и связанных сервисов.

## Введение

- Приложение принимает события Telegram только по HTTPS через внешний терминатор.
- Секреты и токены хранятся в переменных окружения и обслуживаются сервисными учетными данными.
- Управление безопасностью строится на регулярной проверке выполнения требований ASVS и автоматизированных отчётах CI.

## Требования по ASVS

### Управление идентификацией

- Проверять заголовок `X-Telegram-Bot-Api-Secret-Token` на точное совпадение с актуальным секретом до обработки входящего обновления.
- Блокировать повторную обработку обновлений с идентичными `update_id` в течение скользящего окна 10 минут.
- Реализовать rate limiting и экспоненциальный backoff на уровне вебхука согласно значениям `retry_after` и внутренним лимитам.

### Управление конфигурацией

- Секреты, токены и учетные данные хранить исключительно в защищенных хранилищах секретов и прокидывать в приложение через ENV.
- Конфигурацию сервисных учетных записей и ролей БД поддерживать в режиме минимально необходимых привилегий, с документированной ротацией.
- Ввести формализованную политику обновления зависимостей: автоматическая проверка обновлений не реже одного раза в неделю, установка патчей безопасности в течение 48 часов после релиза.

### Управление вводом/выводом

- Валидировать структуру входящих JSON-обновлений Telegram, отклоняя сообщения с неожиданными полями или типами.
- Нормализовать и фильтровать пользовательский ввод при записи заметок настроения, предотвращая XSS/HTML-инъекции.
- Отражать обработанные события только через безопасные каналы (бот-ответы), исключая вывод PII в системные журналы или клиентские сообщения.

### Управление хранением данных

- Шифровать данные пользователей и токены доступа в состоянии покоя, используя современные алгоритмы (AES-256-GCM или эквивалент).
- Разделять продуктивные и тестовые данные, ограничивая доступ разработчиков к продуктивным записям через RBAC.
- Обеспечивать резервное копирование с проверкой восстановления и удаление данных по запросу в течение нормативных сроков.

### Управление журналированием

- Логировать все входящие запросы вебхука с отметками времени, `update_id` и результатом валидации без записи содержимого сообщений.
- Настроить оповещение при превышении лимитов, ошибках проверки подписи или аномальном числе отказов.
- Хранить логи в централизованном хранилище с ротацией и защитой от несанкционированного доступа.

## Процедуры контроля

- Еженедельный запуск SAST с публикацией артефакта отчёта в CI.
- Еженедельный запуск SCA/проверки зависимостей, включая анализ лицензий и CVE.
- [CI SAST Report](https://github.com/org/emotion_diary/actions?query=workflow%3ASAST)
- [CI Dependency Audit](https://github.com/org/emotion_diary/actions?query=workflow%3ASCA)

## Чек-лист тестирования

### Негативные тесты вебхука

- Запрос без заголовка `X-Telegram-Bot-Api-Secret-Token` отклоняется с кодом 401/403.
- Запрос с неверным значением заголовка отклоняется и логируется.
- Повторная отправка идентичного `update_id` в окне дедупликации не приводит к повторной обработке.
- Поток запросов, превышающий лимит, приводит к корректной работе rate limiting и ответам с указанием `retry_after`.

### SAST/SCA

- Проверить, что отчёт SAST не содержит нерешённых блокирующих уязвимостей.
- Убедиться, что отчёт SCA не фиксирует критических CVE и документирует отработку обновлений.

### CI-отчёты

- Подтвердить успешное прохождение всех security-джоб в CI и наличие прикреплённых артефактов отчётов.
- Актуализировать статусы и ссылки на отчёты в случае изменений пайплайна.
